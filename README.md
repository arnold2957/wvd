# wvdas - 巫术daphne的自动挂机脚本
[English (v1.8.20)](README.en.md)

## 本分支的自訂修改（基於 v1.9.20）

**版本基礎：** 上游原作者 arnold2957/wvd v1.9.20

**自訂修改列表：**
1. **旅館自動補給功能** - 進旅館時自動檢測並執行補給（支援普通房和豪華房）
   - 檔案：`src/script.py` StateInn() 函數
   - 新增圖片：`resources/images/box.png`, `resources/images/refill.png`

2. **修復日志系統死鎖問題** - 解決程式運行一段時間後卡死不響應的問題
   - 檔案：`src/utils.py`
   - 修改：將 multiprocessing.Queue 改為 threading.queue.Queue
   - 添加：StopLogListener() 函數，避免資源洩漏
   - 說明：上游使用 multiprocessing.Queue 在多線程環境中會導致死鎖

3. **修復停止機制響應緩慢問題** - 解決點擊停止按鈕後程式無法及時停止的問題
   - 檔案：`src/script.py`
   - 修改：Sleep 函數改為可響應停止信號（每 0.5 秒檢查一次）
   - 修改：RestartableSequenceExecution 在每個操作前檢查停止信號
   - 效果：停止響應時間從最長數十秒降至最多 0.5 秒

4. **禁用自動版本檢查** - 修復檢測到新版本後程式卡死的問題
   - 檔案：`src/main.py` 註解掉 schedule_periodic_update_check()

5. **隱藏控制台窗口** - 運行程式時不顯示黑色命令行窗口
   - 檔案：`localpack.bat` 添加 --noconsole 參數

6. **修復進程不退出問題** - 修復使用 --noconsole 後關閉 GUI 進程仍留在後台的問題
   - 檔案：`src/main.py` 添加 on_closing() 方法
   - 檔案：`src/gui.py` 修改 WM_DELETE_WINDOW 協議處理器
   - 修改：關閉窗口時正確停止任務線程、日誌監聽器並清理資源
   - 效果：程式關閉後進程完全終止，不再需要手動在工作管理員中結束進程

7. **修復截圖函數無限阻塞問題** - 解決運行中程式卡死在截圖操作的問題
   - 檔案：`src/script.py` ScreenShot() 函數
   - 修改：添加停止信號檢查，避免停止時仍卡在截圖
   - 修改：添加最大重試次數限制（5次），避免 ADB 異常時無限重試
   - 效果：截圖失敗時會記錄重試次數並最終拋出異常，避免永久卡住

8. **本地打包腳本** - 使用繁體中文編碼的打包腳本，避免簡體版本的編碼問題
   - 檔案：`localpack.bat`

**上游 v1.9.20 已包含的功能（原為本分支自訂）：**
- ✅ **不打斷自動戰鬥** - 只有在 counter>=4 時才執行畫面點擊，避免打斷戰鬥開始
   - 檔案：`src/script.py` IdentifyState() 函數（第 1225-1233 行）
   - 說明：原作者已在 v1.9.20 實現此功能

---

一个自带gui的巫术手游的刷怪脚本.

和其他流行的游戏自动脚本相比, 针对巫术手游具有的 ***复杂的网络环境*** 和 ***偶尔的性能波动*** 做了专门的特殊优化.

## wvdas具有哪些普通脚本做不到的功能?
### 自动重启
游戏闪退? 立刻重启!

网络故障? 秒点"重试". 一直卡顿? 重启游戏!

卡在宝箱里, 卡在门里, 卡在战斗中, 卡在开箱子流程里, wvdas都能通过检测"静止的画面"或者"过长的耗时"来自动重启游戏.

### "0火转要钱"
一觉醒来发现"再起之火"耗尽了, 游戏停在诅咒之轮, 时间都浪费了怎么办?

wvdas可以再检测到"再起之火"耗尽后, 立刻将任务变更为"找公主要钱".

最大化提高挂机效率~

## 如何安装模拟器并设置脚本?
### 模拟器设置
*蓝叠不再维护, 请不要再使用蓝叠模拟器了.*
- 下载mumu模拟器, mumu12或者mumuX都可以.
- 安装游戏apk.
- 初次加载遇到黑屏, 请安装谷歌三件套. mumu桌面上就有可以直接安装.
- 如果遇到google登录弹窗, 连续按返回即可.
- 如果遇到"违反安全策略", 关闭root.
- 如果遇到"unable to initialize the unity engine graphics API", 先改成DirectX启动, 然后再用vulkan启动就能正常游戏了.
- 模拟器已经**允许adb调试**.
- 模拟器分辨率为**1600x900**, 240 dpi.

### 模拟器设置
- 脚本左上角的"模拟器路径"为:
	 - MuMu12: Netease\MuMu Player 12\shell\MuMuPlayer.exe
	 - MuMuX: Netease\MuMu\nx_device\12.0\shell\MuMuNxDevice.exe
- 端口号为5555或16384. 如果都不可以, 你可以在多开管理器里找到adb端口号.

### 游戏整体设置
- 游戏为**英文版**.
- 画面设置为**中(速度优先)**.
- 调整画面为**30帧**, 地下城亮度为**最暗-25%亮度**.
- 在自动恢复界面, 勾选了"使用技能驱散异常状态".
- 在背包补充界面, 勾选了"将非补充对象的道具存入仓库Place all non-refill items in storage"和"与旅店住宿时自动补充 Automatically refill when staying at the inn.". (如果无法确认, 勾选"持有1个哈肯的钩爪Carry 1 Hook of Harken").
- 游戏地图**没有缩放**. 如已经进行了缩放, 推荐重新安装游戏. (未缩放过的游戏地图应为17个格子左右.)
- 计划使用的技能**必须放快捷栏**, 但是**不能放在左上角**的快捷栏.
- **关闭对话自动选择分支**. 目前皇女要钱和角鹫都是基于不自动选择分支做的.
- 有时间跳跃内容的任务, **务必先手动进行一次(或在一旁盯着看第一次)**, 以避免某些特殊任务的触发导致脚本卡死. 例如: 要塞6f哈肯没法寻路, 王城的工会弹出要钱任务, 悬赏界面的更新提示等等.

### 关卡内部设置
- 游戏地图必须**探明所有区域**. 对于部分进行目标点判定的地图, 至少要探明目标区域的全部地图.
- 游戏内最好已经解锁了目标地图所属的大哈肯.
- 勾选"一场战斗仅释放一次全体aoe"后, 只会释放一次被启用的LA系魔法和秘术. 但仍然需要手动启用秘术或全体aoe.
- 勾选"全体aoe后自动战斗", 会在释放了aoe后变为自动战斗. 但仍然需要手动启用秘术或全体aoe.
- 如果遇到sp不足, 会自动切换成lv1的技能释放. 但是之后的战斗会一直使用lv1技能. 如果想避免这种情况, 请调整住宿间隔.
- 如果出现人物一进副本就卡住无法移动, 这是由于网络问题引起的, 请更换加速器.

### 无头模式
可以用无头模式来启动Wvd!

创建wvd.exe的快捷方式, 并在"目标"一栏的末尾加上" -headless"即可启动无头模式.

还可以使用"-config 路径"来指定特定的config文件.

### 脚本设置
- "智能开箱"是基于图像识别和拟合三角波来做预测的.
	- 目前是通过20张截图来预测的, 比较耗费时间.*(将会在未来版本中修复!)*
- "开箱人选: 随机"会随机指定人物.
- 如果指定了固定开箱角色, 那么在恐惧或石化后会改为其他随机角色.
- 旅店休息间隔是间隔多少次地下城休息. 0代表一直休息, 1代表间隔一次休息, 以此类推. 关闭"启用旅店休息"后, 在刷图地下城和部分任务地下城将永久跳过旅店休息.
- "战斗后恢复"和"开启宝箱后恢复"是指在这两个动作后执行的自动恢复操作. 如果恢复没有驱散异常, 检查游戏设置, 角色技能以及角色异常状态.

#### 蝎女悬赏
- 7级悬赏的蝎女是综合难度和效率的最优选. 由于前7级的难度并不高, 所以目前并不考虑做更前期的悬赏.
- 忍者可以秒杀蝎女, 因此可以尝试组出3忍以上的阵容.
- 前排180闪避就几乎不会被命中, 后排也不会连续被扎, 因此只需要牧师开启"使用本职业技能"即可完成挂机.
- 参考阵容-不释放攻击技能:
  - 前排: 堆叠180闪避, 牧师以及任意角色(推荐忍者). 没有攻击或神力等其他任何要求.
  - 后排: 正常堆攻击的长枪/弓箭战士, 或者堆攻击的苦无忍者.

#### 死神暗灯
- 该任务旨在刷去暗抗装备和小号经验.
- 由于怪物攻击较高, 请保证每人都持有光属性武器(或若干先驱斩)后再进行尝试.
- 在死神地图的左上角和门交互后接取任务, 然后清理一个暗灯周围的所有游荡的怪物.
- 面朝暗灯后开启脚本.

#### 要塞7f刷巨人
- 从要塞出发, 击杀7f门口的那只巨人.
- 首先你需要不停的重置7f地图(跳到第一章第二章再跳跃回来), 直到7f的地图变为**特殊的地图**:
	- 当你站在巨人背后的时候能看到[一盏灯](resources/images/gaint_candelabra_1.png).
- 因为巨人难打而且战斗复杂, 因此这个任务具有**技能序列自定义的功能**. 同时, 整个原有的技能配置面板是完全无效的.
- 默认的技能序列是供如下低配阵容使用的:
	- 二人队伍, 武士和面具法师. 武士站前排, 面具法师站在武士身后.
 	- 武士按照顺序释放如下技能: 防御, 居合xN.
  	- 面具法师按照顺序释放如下技能: LACONESx3, 防御xN.
- 你可以自定义你的队伍技能序列, 访问`wvd\_internal\resources\quest\quest.json`. 从中找到`'gaintKiller'`-`'_SPELLSEQUENCE'`项目.
- 你可以删除`'_SPELLSEQUENCE'`以及冒号后面的内容, 来完全跳过自定义技能序列.
- 你也可以进行自定义. `'_SPELLSEQUENCE'`的每一行遵循如下规则:
	- `"技能栏里有这个技能的人":["先释放这个","再释放这个","最后复读这个"]`
	- 例如, 默认的方案里, 面具法师按照顺序释放如下技能: LACONESx3, 防御xN.
		 - 因此, 我们要写`"LACONES":["LACONES","LACONES","LACONES","defend"],`
   - 注意, 进行识别的技能和序列中的技能未必要一致. 你可以写类似于"携带了锁腹刺的人释放两次居合然后防御"
		- 因此, 可以写`"锁腹刺":["居合","居合","defend"],`
   - 技能名称是"法系技能的全称"和"物理技能的首字母".
- 之后会使用可以自由配置的面板.
- 现在支持的技能列表如下(按照优先级排列, 越前面的优先级越高):
   - 控制技能 = ["KANTIOS"]
   - 秘术 = ["SAoLABADIOS","SAoLAERLIK","SAoLAFOROS"]
   - 全体aoe = ["LAERLIK", "LAMIGAL","LAZELOS", "LACONES", "LAFOROS","LAHALITO", "LAFERU"]
   - 单排aoe = ["maerlik", "mahalito", "mamigal","mazelos","maferu", "macones","maforos","终焉之刻", "千恋万花"]
   - 强力单体 = ["全力一击","tzalik","居合","精密攻击","锁腹刺","破甲","星光裂","迟钝连携击","强袭","重装一击","眩晕打击","幻影狩猎"]

#### 离别洞窟 / 约定之剑:
- 该洞窟的开箱难度较高, 推荐盗贼主角或者专门培养的开箱工具人.
- 克拉丽莎可以大幅度简化这个洞窟的战斗. 通过将其放置在前排中央, 你可以很好的抵抗魅魔的魅惑. 可以使用全部自动战斗.
- 否则, 推荐1速aoe输出来秒杀魅魔, 速度>90, 魔力>450, 还需要后排配爱丽丝+前排光环工具人来补充20%伤害.
- 该洞窟有大量战斗, 推荐携带2组aoe+增伤的组合. 也可以仅携带1组再携带2个小号.
- 参考aoe+增伤的组合:
	  夏莉莉+米拉娜(续航优秀, 可开锁) > 叶卡+艾莉赛(可以防止偷袭同时单光环足矣, 但续航不足) > 亚当+黛博拉(可开锁, 但续航不足) > 亚当+阿贝(先驱斩浪费时间而且无效伤害, 续航不足, 不推荐)

#### 三牛任务:
- 从时空跳跃启动, 目标点为"击败吾等荣光", 请确保击杀了人偶. 注意第一次跳人偶可能无法点亮哈肯, 需要手动操作.
- 基本流程为: 跳跃-左上角一牛-**回家休息(可选)**-右边两牛-跳跃. 要想关闭途中的回家休息, 请关闭"**启用旅店休息**".
- 低配阵容推荐: 4人队伍.
 	- 2战士, 160+回避, 300+攻击, +20冥钢武器(或角鹫之剑), 只释放全力一击.
	- 1牧师, 速度最慢, 闪避能堆多高堆多高, **站前排**, 只是放卡恩停欧斯.
 	- 1法师/1牧师, 速度最快, 魔力能堆多高堆多高, **站牧师后面**, 释放LA系魔法或秘术.
	- 技能启用: 关闭系统自动战斗, 勾选"群体控制","强力单体"以及"全体AOE".
	- 推荐勾选'跳过**开箱**后恢复', "启用旅店休息".
    - 三牛的威胁之处在于它可以造成前后换位以及石化呼吸. 高闪避的牧师可以克制换位, 而没有后排只有前排的构筑同样可以克制换位. 至于石化呼吸, 正好交给堆闪避的牧师来控制.
	- 参考阵容: 战士面具左上, 牧师叶卡中上, 战士王女右上, 睡法中下.
	- 变种阵容: 牧师面具左上, 战士艾莉赛中上, 战士王女右上, 牧师叶卡中下.
		- 利用牧师叶卡的秘术来充当法师的AOE, 有艾莉赛光环, 伤害充足.
		- 艾莉赛站叶卡前面, 需要堆闪避. 但是因为双光环, 伤害充足.
#### 沙影洞:
- 该任务的休息旅店为要塞, 请确保要塞可见.
- 不推荐在没有完成2周目的情况下使用脚本.
- 注意该任务需要**通关2周目且获得解除陷阱的知识**. 在完成了2周目后, 从boss房间处获取知识以了解如何关闭陷阱.
- 注意, **1f地图左右下角的隐藏区域极其容易被遗漏**, 请访问gamerch以确认解锁了全部地图: [攻略](https://gamerch.com/wizardry-daphne/928695),以及 [地图](https://cdn.gamerch.com/resize/eyJidWNrZXQiOiJnYW1lcmNoLWltZy1jb250ZW50cyIsImtleSI6Indpa2lcLzQ3MTRcL2VudHJ5XC9DVGJLWWRESy5qcGciLCJlZGl0cyI6eyJ0b0Zvcm1hdCI6IndlYnAiLCJqcGVnIjp7InF1YWxpdHkiOjg1fX19)
- 目前提供了三个版本:
   	- 1F回溯刷金箱. 流程为 回溯->双忍者->三个金箱子->其他箱子. .
   	- 刷怪. 能穿过7个怪物的路线, 平均一次副本能触发5次左右战斗.
   	- 全拿. 在刷怪的基础上, 还会额外搜索地图上的箱子.
#### 贸易水路-船舱2层:
- 确保船1上半部分的地图全部点亮, 船2上半部分的地图全部点亮.
#### 矿石洞: 
- 土洞目前只有一个目标点. 打了就会回城.
- 确保火洞第一个大方块区域内全部点亮. 尤其是大方块的左下角部分.
- 确保光洞第一个大方块区域内全部点亮. 尤其是大方块中部区域.

#### "角鹫之剑"任务: 
- 面板**仅能控制最后的boss战**, 路上小怪为**强制自动战斗**. 流程中不包含回城, 所以量力而行.
- 请确保某些地图中某些区域的全部开启.
- 开第三层的哈肯有一定概率失败, 并导致角色死亡.*(暂时不会修复!)*

## 如何反馈信息?
- 你可以在log文件夹中找到log.txt以及屏幕截图.
- 你可以发送单个log.txt文件, 或者将整个log文件夹打包发送.

## 我有一个点子/我想要贡献代码
感谢你对于本项目的支持! 但首先, 请访问wiki来了解更多信息.

## 我想要赞助这个项目
非常感谢你的支持!
你可以访问爱发电来为项目提供赞助: [爱发电](https://afdian.com/a/dellyla)
